#!/usr/bin/env bash

# exit when any command fails
set -e

USER=${SUDO_USER:-$USER}
GROUP=$(id -gn $USER)

if ![ -e ./build/xrDriver ]; then
  ./bin/build
fi

ARCH=$(uname -m)
echo "Packaging for $ARCH"

# create package
PACKAGE_DIR=xr_driver
PACKAGE_BIN_DIR=$PACKAGE_DIR/bin
PACKAGE_USER_BIN_DIR=$PACKAGE_BIN_DIR/user
mkdir -p $PACKAGE_USER_BIN_DIR

mv ./build/xrDriver $PACKAGE_BIN_DIR/xrDriver

# copy setup and user-relevant scripts
cp ./bin/setup $PACKAGE_DIR
cp ./bin/{xr_driver_verify,xr_driver_cli,xr_driver_uninstall} $PACKAGE_BIN_DIR
cp ./bin/user/{install,systemd_start} $PACKAGE_USER_BIN_DIR

# copy the systemd files needed to run our service
cp -r ./systemd $PACKAGE_DIR
cp -r ./udev $PACKAGE_DIR

# copy the shared library files
if [ ! -d "$PACKAGE_DIR/lib" ]; then
  mkdir $PACKAGE_DIR/lib
fi
cp ./lib/$ARCH/*.so $PACKAGE_DIR/lib || true

# create manifest file for verifying installed file checksums against the originally packaged versions
# include any file that doesn't get modified during setup (e.g. the systemd service file)
pushd $PACKAGE_BIN_DIR
BIN_MANIFEST=$(sha256sum xrDriver xr_driver_cli xr_driver_uninstall)
popd
echo $BIN_MANIFEST > $PACKAGE_DIR/manifest

# bundle up the driver directory
tar -zcvf xrDriver-$ARCH.tar.gz $PACKAGE_DIR
